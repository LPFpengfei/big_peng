<style>
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); }
  .modal.show { display: flex; align-items: center; justify-content: center; }
  .modal-content { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; }
  .modal-header h3 { margin: 0; font-size: 20px; color: #1f2937; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
  .modal-close:hover { color: #1f2937; }
  .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; padding-top: 12px; border-top: 1px solid #e5e7eb; }
  .btn-secondary { background: #e5e7eb; color: #1f2937; }
  .btn-secondary:hover { background: #d1d5db; }
</style>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0;">图书管理</h2>
    <button class="btn" onclick="openModal('new')">新增图书</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>标题</th>
        <th>作者</th>
        <th>分类</th>
        <th>来源</th>
        <th>创建时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @books.each do |book| %>
        <tr>
          <td><%= book.id %></td>
          <td><%= book.title %></td>
          <td><%= book.author %></td>
          <td><%= book.category&.name || '未分类' %></td>
          <td><%= book.source %></td>
          <td><%= book.created_at.strftime('%Y-%m-%d %H:%M') %></td>
          <td>
            <button class="btn" style="padding: 4px 8px; font-size: 12px; cursor: pointer; margin-right: 4px;" onclick="location.href='<%= admin_book_path(book) %>'">查看</button>
            <button class="btn" style="padding: 4px 8px; font-size: 12px; cursor: pointer; margin-right: 4px;" onclick="openModal('edit', <%= book.id %>)">编辑</button>
            <%= button_to "删除", admin_book_path(book), method: :delete,
                data: { turbo_confirm: "确定要删除这本书吗？" },
                class: "btn btn-danger",
                style: "padding: 4px 8px; font-size: 12px; display: inline-block; margin-right: 4px;" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div style="margin-top: 16px;">
  <%= paginate @books %>
  <span style="margin-left: 8px; color: #555;">当前页：<%= (@books.respond_to?(:current_page) ? @books.current_page : 1) %></span>
  <% if @books.respond_to?(:total_pages) %>
    <span style="margin-left: 8px; color: #555;">总页数：<%= @books.total_pages %></span>
  <% end %>
</div>

<!-- 模态框 -->
<div id="bookModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">新增图书</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
  async function openModal(action, id = null) {
    const modal = document.getElementById('bookModal');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');

    try {
      let url = action === 'new' ? '<%= new_admin_book_path %>' : `<%= edit_admin_book_path(':id') %>`.replace(':id', id);
      const response = await fetch(url);
      const html = await response.text();

      modalBody.innerHTML = html;
      modalTitle.textContent = action === 'new' ? '新增图书' : '编辑图书';
      modal.classList.add('show');

      // 绑定表单提交事件
      const form = modalBody.querySelector('form');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          submitForm(form, action, id);
        });
      }
    } catch (error) {
      console.error('Error:', error);
      alert('加载表单失败');
    }
  }

  function closeModal() {
    const modal = document.getElementById('bookModal');
    modal.classList.remove('show');
  }

  async function submitForm(form, action, id = null) {
    const formData = new FormData(form);
    const url = action === 'new' ? '<%= admin_books_path %>' : `<%= admin_book_path(':id') %>`.replace(':id', id);
    const method = action === 'new' ? 'POST' : 'PATCH';

    try {
      const response = await fetch(url, {
        method: method,
        body: formData,
        credentials: 'include',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert(data.message);
        closeModal();
        location.reload();
      } else {
        const errors = data.errors.join('\n');
        alert('错误:\n' + errors);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('提交失败');
    }
  }

  // 点击模态框背景关闭
  document.getElementById('bookModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });
</script>