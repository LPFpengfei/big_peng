<%# 管理端图书列表页面 %>
<% content_for :title, "图书管理" %>

<div class="container mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold mb-6">图书管理</h1>

  <!-- 新增图书按钮 -->
  <div class="mb-4">
    <button id="new-book-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
      新增图书
    </button>
  </div>

  <!-- 图书列表 -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-200">
      <thead>
        <tr>
          <th class="py-3 px-4 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
          <th class="py-3 px-4 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标题</th>
          <th class="py-3 px-4 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作者</th>
          <th class="py-3 px-4 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
          <th class="py-3 px-4 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">来源</th>
          <th class="py-3 px-4 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
          <th class="py-3 px-4 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <% @books.each do |book| %>
          <tr>
            <td class="py-3 px-4"><%= book.id %></td>
            <td class="py-3 px-4"><%= book.title %></td>
            <td class="py-3 px-4"><%= book.author %></td>
            <td class="py-3 px-4"><%= book.category&.name || '未分类' %></td>
            <td class="py-3 px-4"><%= book.source %></td>
            <td class="py-3 px-4"><%= book.created_at.strftime('%Y-%m-%d %H:%M') %></td>
            <td class="py-3 px-4">
              <%= link_to "查看", admin_book_path(book), class: "text-blue-500 hover:text-blue-700 mr-2" %>
              <button class="edit-book-btn text-yellow-500 hover:text-yellow-700 mr-2" data-id="<%= book.id %>">
                编辑
              </button>
              <%= link_to "删除", admin_book_path(book), method: :delete, data: { confirm: "确定要删除这本书吗？" }, class: "text-red-500 hover:text-red-700" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- 分页 -->
  <div class="mt-4">
    <%= paginate @books %>
  </div>
</div>

<!-- 新增/编辑图书模态框 -->
<div id="book-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
    <!-- 模态框标题 -->
    <div class="flex justify-between items-center mb-4">
      <h3 id="modal-title" class="text-lg font-medium text-gray-900">新增图书</h3>
      <button id="close-modal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <!-- 模态框内容 -->
    <div id="modal-content">
      <!-- 表单内容将通过AJAX加载 -->
    </div>
  </div>
</div>

<script>
  // 新增图书按钮点击事件
  document.getElementById('new-book-btn').addEventListener('click', function() {
    fetch('<%= new_admin_book_path(format: :html) %>')
      .then(response => response.text())
      .then(html => {
        document.getElementById('modal-title').textContent = '新增图书';
        document.getElementById('modal-content').innerHTML = html;
        document.getElementById('book-modal').classList.remove('hidden');
      });
  });

  // 编辑图书按钮点击事件
  document.querySelectorAll('.edit-book-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const bookId = this.dataset.id;
      fetch(`<%= admin_books_path %>/${bookId}/edit`)
        .then(response => response.text())
        .then(html => {
          document.getElementById('modal-title').textContent = '编辑图书';
          document.getElementById('modal-content').innerHTML = html;
          document.getElementById('book-modal').classList.remove('hidden');
        });
    });
  });

  // 关闭模态框
  document.getElementById('close-modal').addEventListener('click', function() {
    document.getElementById('book-modal').classList.add('hidden');
  });

  // 点击模态框外部关闭
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('book-modal');
    if (event.target === modal) {
      modal.classList.add('hidden');
    }
  });
</script>