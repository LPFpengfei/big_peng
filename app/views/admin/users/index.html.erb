<style>
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); }
  .modal.show { display: flex; align-items: center; justify-content: center; }
  .modal-content { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; }
  .modal-header h3 { margin: 0; font-size: 20px; color: #1f2937; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
  .modal-close:hover { color: #1f2937; }
  .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; padding-top: 12px; border-top: 1px solid #e5e7eb; }
  .btn-secondary { background: #e5e7eb; color: #1f2937; }
  .btn-secondary:hover { background: #d1d5db; }
</style>

<% content_for :title, "用户管理" %>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0;">用户管理</h2>
    <button class="btn" onclick="openModal('new')">新增用户</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>昵称</th>
        <th>邮箱</th>
        <th>创建时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr>
          <td><%= user.id %></td>
          <td><%= user.nickname %></td>
          <td><%= user.email %></td>
          <td><%= user.created_at.strftime('%Y-%m-%d %H:%M') %></td>
          <td>
            <button class="btn" style="padding: 4px 8px; font-size: 12px; cursor: pointer; margin-right: 4px;" onclick="location.href='<%= admin_user_path(user) %>'">查看</button>
            <button class="btn" style="padding: 4px 8px; font-size: 12px; cursor: pointer; margin-right: 4px;" onclick="openModal('edit', <%= user.id %>)">编辑</button>
            <%= button_to "删除", admin_user_path(user), method: :delete,
                data: { turbo_confirm: "确定要删除这个用户吗？" },
                class: "btn btn-danger",
                style: "padding: 4px 8px; font-size: 12px; display: inline-block; margin-right: 4px;" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div style="margin-top: 16px;">
  <%= paginate @users %>
  <span style="margin-left: 8px; color: #555;">当前页：<%= (@users.respond_to?(:current_page) ? @users.current_page : 1) %></span>
  <% if @users.respond_to?(:total_pages) %>
    <span style="margin-left: 8px; color: #555;">总页数：<%= @users.total_pages %></span>
  <% end %>
</div>

<!-- 模态框 -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">新增用户</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
  async function openModal(action, id = null) {
    const modal = document.getElementById('userModal');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');

    try {
      let url = action === 'new' ? '<%= new_admin_user_path %>' : `<%= edit_admin_user_path(':id') %>`.replace(':id', id);
      const response = await fetch(url);
      const html = await response.text();

      modalBody.innerHTML = html;
      modalTitle.textContent = action === 'new' ? '新增用户' : '编辑用户';
      modal.classList.add('show');

      // 绑定表单提交事件
      const form = modalBody.querySelector('form');
      if (form) {
        console.log('Form Action:', form.action);
        console.log('Form Method:', form.method);

        // 调试：查看表单的CSRF令牌字段
        const csrfTokenField = form.querySelector('input[name="authenticity_token"]');
        console.log('CSRF Token Field:', csrfTokenField ? 'Found' : 'Not found');
        if (csrfTokenField) {
          console.log('CSRF Token Value:', csrfTokenField.value);
        }

        form.addEventListener('submit', function(e) {
          e.preventDefault();
          submitForm(form, action, id);
        });
      }
    } catch (error) {
      console.error('Error:', error);
      alert('加载表单失败');
    }
  }

  function closeModal() {
    const modal = document.getElementById('userModal');
    modal.classList.remove('show');
  }

  async function submitForm(form, action, id = null) {
    try {
      // 调试：查看表单数据
      const formData = new FormData(form);
      console.log('Form Data:');
      for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
      }

      const url = action === 'new' ? '<%= admin_users_path %>' : `<%= admin_user_path(':id') %>`.replace(':id', id);
      const method = action === 'new' ? 'POST' : 'PATCH';

      console.log('Request URL:', url);
      console.log('Request Method:', method);

      const response = await fetch(url, {
        method: method,
        body: formData,
        credentials: 'include',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      });

      console.log('Response Status:', response.status);
      const responseText = await response.text();
      console.log('Response Text:', responseText);

      // 尝试解析JSON响应
      const data = JSON.parse(responseText);
      console.log('Parsed Response:', data);

      if (data.success) {
        alert(data.message);
        closeModal();
        location.reload();
      } else {
        const errors = data.errors.join('\n');
        alert('错误:\n' + errors);
      }
    } catch (error) {
      console.error('Error in submitForm:', error);
      alert('提交失败: ' + error.message);
    }
  }

  // 点击模态框背景关闭
  document.getElementById('userModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });
</script>